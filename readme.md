# Ansible and Terraform Infrastructure Setup

This repository contains the necessary Terraform configurations and Ansible playbooks for provisioning and configuring virtual machines on an ESXi host. The infrastructure as code approach ensures consistency, repeatability, and version control for infrastructure management.

## Overview

- **Terraform**: Used for provisioning virtual machines on an ESXi server.
- **Ansible**: Used for configuring the provisioned virtual machines to serve various roles like Domain Controller, KMS Server, Print Server, and Web Server.
- **`gen_config.py`**: A Python script that generates `vm.tf` Terraform configuration files dynamically, based on defined VM templates and settings.

## Structure

- `main.tf`: Terraform configuration that sets up the provider for ESXi.
- `vm.tf`: Terraform configurations for each virtual machine, including resource definitions and provisioning details. This file is generated by the `gen_config.py` script.
- `gen_config.py`: Python script that generates `vm.tf` based on predefined virtual machine configurations.
- `playbooks/`: Directory containing Ansible playbooks for configuring virtual machines.
  - `domaincontroller.yml`: Configures a Windows VM as a Domain Controller.
  - `kmsserver.yml`: Configures a Windows VM as a KMS Server.
  - `printserver.yml`: Configures a Windows VM as a Print Server.
  - `webserver.yml`: Configures a Linux VM as a Web Server.

## Prerequisites

- Terraform installed on your local machine or CI/CD environment.
- Ansible installed on your local machine or CI/CD environment.
- Python installed for running `gen_config.py`.
- Access to an ESXi server where the virtual machines will be provisioned.
- Necessary credentials for connecting to the ESXi server and for SSH/WinRM access to the virtual machines.

## Usage

1. Clone the repository to your local machine or CI/CD environment.
2. Navigate to the repository directory.

    ```sh
    cd ansible-demo/terraform
    ```

3. Run the `gen_config.py` script to generate the `vm.tf` file based on your VM definitions.

    ```sh
    python gen_config.py
    ```

4. Initialize Terraform (downloads required providers).

    ```sh
    terraform init
    ```

5. Review the Terraform plan to understand the changes that will be made.

    ```sh
    terraform plan
    ```

6. Apply the Terraform configuration to start provisioning the virtual machines.

    ```sh
    terraform apply
    ```

7. Once the virtual machines are provisioned, Ansible will automatically configure them according to the playbooks specified in the `vm.tf` file.

## Security Considerations

- Avoid hardcoding sensitive information like passwords in your configuration files. Use environment variables or a secrets management tool instead.
- Ensure that SSH and WinRM services are securely configured and accessible only from trusted networks.
- Review the security groups and firewall settings to expose only necessary ports to the outside world.